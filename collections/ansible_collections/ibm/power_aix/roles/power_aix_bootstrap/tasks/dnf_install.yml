# Copyright (c) IBM Corporation 2021
---
#   Verify the AIX level is 7.1 or above. Bootstrap dnf is only supported in AIX 7.1 and up.
- name: Verify the host is at least aix 7.1, if not, exit host
  ansible.builtin.raw: /usr/bin/oslevel  | /usr/bin/awk -F '.' ' { print $1 $2 }'
  register: power_aix_bootstrap_output
  changed_when: false

# Fail if version is less than 7.1
- name: Fail if AIX version is less than 7.1
  ansible.builtin.fail:
    msg: Bootstrap for AIX version {{ power_aix_bootstrap_output.stdout_lines[0] }} is not supported.
  when: (power_aix_bootstrap_output.stdout_lines[0] | int) < 71

#   CHECK for DNF on inventory host
- block:
    - name: Check for existence of dnf
      ansible.builtin.raw: /opt/freeware/bin/rpm -q --quiet dnf && echo true || echo false
      register: power_aix_bootstrap_dnf_exists
      changed_when: false

    - name: Print if dnf is installed
      ansible.builtin.debug:
        msg: Exiting the playbook. dnf is already installed
      when: power_aix_bootstrap_dnf_exists.stdout is search("true")

    - name: Check for existence of yum
      ansible.builtin.raw: /opt/freeware/bin/rpm -q --quiet yum && echo true || echo false
      register: power_aix_bootstrap_yum_exists
      changed_when: false
      when: power_aix_bootstrap_dnf_exists.stdout is search("false")

# Execute this block if DNF doesn't exist and AIX version is either 7.1 or 7.2
- when:
    - power_aix_bootstrap_dnf_exists.stdout is search("false")
    - (power_aix_bootstrap_output.stdout_lines[0] | int) in [71, 72]

  block:
    - name: Create target filesystem for image transfer
      ansible.builtin.raw: crfs -v jfs2 -g rootvg -a size=530M -m {{ power_aix_bootstrap_target_dir }} -A yes -p rw
      changed_when: true
    - name: Mount target filesystem
      ansible.builtin.raw: mount {{ power_aix_bootstrap_target_dir }}
      changed_when: true

- when: (power_aix_bootstrap_output.stdout_lines[0] | int) == 73 and power_aix_bootstrap_dnf_exists.stdout is search("false")

  # Excute this block if dnf is not installed
  block:
    - name: Set the python interpreter to python3
      ansible.builtin.set_fact:
        ansible_python_interpreter: /usr/bin/python3

    - name: Create target filesystem for image transfer if it does not exist "{{ power_aix_bootstrap_target_dir }}"
      ibm.power_aix.filesystem:
        state: present
        filesystem: "{{ power_aix_bootstrap_target_dir }}"
        fs_type: jfs2
        auto_mount: true # noqa yaml
        attributes: size=530M
        permissions: rw
        vg: rootvg

    - name: Mount target filesystem "{{ power_aix_bootstrap_target_dir }}"
      ibm.power_aix.mount:
        mount_dir: "{{ power_aix_bootstrap_target_dir }}"

- when: power_aix_bootstrap_dnf_exists.stdout is search("false")

  # { Execute this block to install dnf and proxy needs to be set
  block:

    # Check for existence of python and python3 as without it copy can't be used.
    - name: Check if Python is installed
      ansible.builtin.raw: which python
      register: power_aix_bootstrap_python_installed
      ignore_errors: true  # Continue even if the command fails
      changed_when: false

    - name: Check if Python3 is installed (for systems that use Python3 as default)
      ansible.builtin.raw: which python3
      register: power_aix_bootstrap_python3_installed
      ignore_errors: true # Continue even if the command fails
      changed_when: false

    - when: not power_aix_bootstrap_local_repo
      block:
        - when: power_aix_bootstrap_python_installed.rc == 0 or power_aix_bootstrap_python3_installed.rc == 0
          block:
            - name: Copy dnf install script to "{{ power_aix_bootstrap_target_dir }}"
              ansible.builtin.copy:
                src: "{{ item }}"
                dest: "{{ power_aix_bootstrap_target_dir }}"
                mode: "0755"
              with_items:
                - files/{{ power_aix_bootstrap_dnf_install_script }}

        # When python and python3 is not present on the system, copy module can not be used. Need to scp instead.
        - when: power_aix_bootstrap_python_installed.rc != 0 and power_aix_bootstrap_python3_installed.rc != 0
          block:
            - name: Prepare remote target variables
              ansible.builtin.set_fact:
                power_aix_bootstrap_target_user: "{{ ansible_user | default(lookup('env', 'USER')) }}"
                power_aix_bootstrap_target_host: "{{ (ansible_host | default(inventory_hostname)) | regex_replace('.*@', '') }}"

            - name: Copy file to {{ power_aix_bootstrap_target_dir }}
              # Using regex replace, catering to different styles of managing inventories.
              # Using defaults, for cases when ansible_user and ansible_host are not defined or can't be fetched.
              ansible.builtin.raw: >
                scp ./roles/power_aix_bootstrap/files/{{ power_aix_bootstrap_dnf_install_script }}
                {{ power_aix_bootstrap_target_user }}@{{ power_aix_bootstrap_target_host }}:{{ power_aix_bootstrap_target_dir }}
              delegate_to: localhost
              changed_when: true

            - name: Give permissions to the file
              ansible.builtin.raw: chmod 755 {{ power_aix_bootstrap_target_dir }}/{{ power_aix_bootstrap_dnf_install_script }}
              changed_when: true

        - name: Restore dnf bundle to upgrade yum to yum4 if yum is installed.
          ansible.builtin.raw: "{{ power_aix_bootstrap_target_dir }}/{{ power_aix_bootstrap_dnf_install_script }} -y {{ power_aix_bootstrap_target_dir }}"
          changed_when: true
          when:
            - power_aix_bootstrap_yum_exists.stdout is search("true")

        - name: Restore dnf bundle at the target if yum is not installed.
          ansible.builtin.raw: "{{ power_aix_bootstrap_target_dir }}/{{ power_aix_bootstrap_dnf_install_script }} -d {{ power_aix_bootstrap_target_dir }}"
          changed_when: true
          when:
            - power_aix_bootstrap_yum_exists.stdout is not search("true")

    - when: power_aix_bootstrap_local_repo

      block:
        # Both the paths need to be provided in case of local repo setup
        - name: Fail if 'power_aix_bootstrap_dnf_repo_mount_path' and 'power_aix_bootstrap_dnf_bundle_mount_path' are not provided
          ansible.builtin.fail:
            msg: "Both power_aix_bootstrap_dnf_repo_mount_path and power_aix_bootstrap_dnf_bundle_mount_path must be defined!"
          when: (power_aix_bootstrap_dnf_repo_mount_path is not defined) or (power_aix_bootstrap_dnf_bundle_mount_path is not defined)

        - when: power_aix_bootstrap_python_installed.rc == 0 or power_aix_bootstrap_python3_installed.rc == 0
          block:
            - name: Copy dnf local install script to "{{ power_aix_bootstrap_target_dir }}"
              ansible.builtin.copy:
                src: "{{ item }}"
                dest: "{{ power_aix_bootstrap_target_dir }}"
                mode: "0755"
              with_items:
                - files/{{ power_aix_bootstrap_local_repo_script }}

        # When python and python3 is not present on the system, copy module can not be used. Need to scp instead.
        - when: power_aix_bootstrap_python_installed.rc != 0 and power_aix_bootstrap_python3_installed.rc != 0
          block:
            - name: Prepare remote target variables
              ansible.builtin.set_fact:
                power_aix_bootstrap_target_user: "{{ ansible_user | default(lookup('env', 'USER')) }}"
                power_aix_bootstrap_target_host: "{{ (ansible_host | default(inventory_hostname)) | regex_replace('.*@', '') }}"

            - name: Copy file to {{ power_aix_bootstrap_target_dir }}
              # Using regex replace, catering to different styles of managing inventories.
              # Using defaults, for cases when ansible_user and ansible_host are not defined or can't be fetched.
              ansible.builtin.raw: >
                scp ./roles/power_aix_bootstrap/files/{{ power_aix_bootstrap_local_repo_script }}
                {{ power_aix_bootstrap_target_user }}@{{ power_aix_bootstrap_target_host }}:{{ power_aix_bootstrap_target_dir }}
              delegate_to: localhost
              changed_when: true

            - name: Give permissions to the file
              ansible.builtin.raw: chmod 755 {{ power_aix_bootstrap_target_dir }}/{{ power_aix_bootstrap_local_repo_script }}
              changed_when: true

        - name: Restore dnf bundle to upgrade yum to yum4 if yum is installed
          ansible.builtin.raw: >
            {{ power_aix_bootstrap_target_dir }}/{{ power_aix_bootstrap_local_repo_script }}
            {{ power_aix_bootstrap_dnf_repo_mount_path }}
            {{ power_aix_bootstrap_dnf_bundle_mount_path }}
          changed_when: true

    - name: Check if dnf was installed at /opt/freeware/bin
      ansible.builtin.stat:
        path: /opt/freeware/bin/dnf
      register: power_aix_bootstrap_dnf_installed

    - name: Check if yum link was installed at /opt/freeware/bin
      ansible.builtin.stat:
        path: /opt/freeware/bin/yum
      register: power_aix_bootstrap_yum_link_installed

    # Ansible at times does not fetch PATH from the system, rather uses its own ansible_path
    - name: Get full PATH from shell
      ansible.builtin.raw: echo $PATH
      register: power_aix_bootstrap_current_path
      changed_when: false

    - name: Update "{{ ansible_python_interpreter }}"
      ansible.builtin.shell:
        cmd: |
          /opt/freeware/bin/dnf -y upgrade python3
      register: power_aix_bootstrap_update_python
      failed_when: power_aix_bootstrap_update_python.rc != 0
      changed_when: power_aix_bootstrap_update_python.rc == 0
      vars:
        ansible_python_interpreter: "{{ power_aix_bootstrap_interpreter_name }}"
      when:
        - power_aix_bootstrap_dnf_installed.stat.exists
      environment:
        PATH: "{{ power_aix_bootstrap_current_path.stdout }}:/opt/freeware/bin"

    - name: Print status
      ansible.builtin.debug:
        msg: Bootstrap attempt of yum upgrade to dnf on {{ power_aix_bootstrap_aix_host }} has completed
      when: power_aix_bootstrap_yum_link_installed.stat.exists

    - name: Print status
      ansible.builtin.debug:
        msg: Bootstrap attempt of dnf on {{ power_aix_bootstrap_aix_host }} has completed
      when: power_aix_bootstrap_dnf_installed.stat.exists

  always:
    # Need to use raw instead of specific modules as python may not be present in few cases
    - name: Unmount target filesystem "{{ power_aix_bootstrap_target_dir }}"
      ansible.builtin.raw: umount "{{ power_aix_bootstrap_target_dir }}"
      changed_when: true

    - name: Remove "{{ power_aix_bootstrap_target_dir }}"
      ansible.builtin.raw: rmfs "{{ power_aix_bootstrap_target_dir }}"
      changed_when: true

#    Block to install dnf }
- when: (power_aix_bootstrap_dnf_exists.stdout is not search("false") or power_aix_bootstrap_dnf_installed.stat.exists) and "proxy" is defined
  block:
    - name: Add proxy to /opt/freeware/etc/dnf/dnf.conf
      ansible.builtin.lineinfile:
        path: /opt/freeware/etc/dnf/dnf.conf
        line: proxy={{ power_aix_bootstrap_proxy }}
        insertafter: best=True

  #     Block to set proxy }
